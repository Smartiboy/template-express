# Express初始化项目模板

> 作者：Jimi
>
> 创建时间：2021/07/26
>
> 更新时间：2021/08/05

# 一、模板说明

本项目是一个Express初始化项目模板，其基于脚手架工具`express-generator@4.16.1`。

直接使用此脚手架工具生成的项目是一个全栈项目，但实际上现在我们的工作基本上都是前后端分离的，因此我对其进行了删减处理，移除了视图模块和静态资源，并对`app.js`文件进行了删减和中文注释，也在其基础上新增了很多内容，具体查看相关模板依赖及模板特色。

# 二、模板依赖

在原有的依赖基础上，我新增了如下依赖包：

- cross-env：实现控制环境变量
- mysql：操作mysql数据库
- xss：预防xss攻击
- joi：数据校验
- @escook/express-joi：基于joi的中间件
- bcryptjs：数据加密

# 三、模板特色

1.根据RESTful规则进行封装了成功或失败的数据返回，可以通过错误状态码来返回对应的错误消息，也可以自定义返回状态码和错误消息

```json
{
    "message": "邮箱不符合校验规则",
    "data": null,
    "status": "error",
    "code": 400
}
```

2.项目的所有错误信息都会以JSON格式返回给用户

3.支持pm2进程守护

4.项目结构清晰

# 四、问题讨论

## 1.错误数据返回

我之前对错误数据返回的理解上有误，我以为只要客户端请求不满足业务要求就可以返400状态码，但是实际上并不严谨，因为400的定义是用户发出的请求有错误，服务器不理解客户端的请求<span style="color: red;">且未做任何处理</span>，而我们有的接口请求是成功的，只是在业务上不符合要求，比如数据校验，因此我个人觉得返回的状态码应该为请求成功的状态码200/201，这样更加合理严谨，从v0.6.0开始更改错误数据返回方式。

## 2.业务状态码

从v0.6.0开始新增业务状态码，其原因是在对接前端项目的时候发现前端在响应拦截器里通过判断后端返回的状态码来决定是否返回响应数据，后端返回的code状态码有可能是自定义状态码也可能是HTTP状态码，在网上也找了相关资料，发现并没有统一的规范，因此我了选择返回HTTP状态码，其符合RESTful规则。在实际开发过程中前端请求的时候我发现接口请求是没有问题的，而实际上可能并不符合业务要求，例如注册的时候，用户名可能重复了则后端不允许继续注册操作，这个时候接口是返回的201，成功的POST请求状态码，但是业务要求并不满足，因此这个时候我们可以通过返回`status`状态来判断业务上的判断是否成功，如果成功则返回`success`，反之`error`。

且与前端商榷好，在响应拦截器中去判断后端返回的HTTP状态码是否为成功状态码，如果不是则继续去判断是不是401token过期等问题，如果是成功状态码，则去判断业务状态是否成功，如果成功则返回响应数据，如果失败则抛出异常给用户。

# 四、更新日志

## v0.1.2
`2021/07/26`
- 🐞 修复呈现错误页问题

## v0.1.3
`2021/07/26`
- 🆕 新增git忽略文件

## v0.2.0
`2021/07/26`
- 🛠使用es6语法
- 🆕 新增代码统一风格
- 🆕 新增生产环境启动命令
- 🆕 新增pm2配置文件
- 🆕 新增日志文件
- 🆕 根据不同环境进行不同的日志配置
- 🛠 更改目录结构

## v0.3.0
`2021/07/29`
- 🚀 express升级到4.17.1
- 🆕 新增git忽略日志文件
- 🪓️ 移除jade包
- 🛠 优化错误消息提示

## v0.4.0
`2021/08/03`
- 🆕 新增数据库配置文件
- 🆕 新增Mysql连接配置
- 🆕 封装xss和sql注入
- 🆕 封装数据返回模型

## v0.5.0
`2021/08/04`
- 🛠 优化处理其他处理程序错误数据返回形式
- 🛠 优化捕获404并返回错误数据
- 🆕 新增捕获错误信息
- 🪓️ 移除http-errors包
- 🆕 新增controller目录专门处理数据操作
- 🆕 新增schema目录专门处理数据校验
- 🆕 新增bcryptjs加密包
- 🆕 新增joi数据校验包
- 🆕 新增@escook/express-joi中间件包
- 🐞 修复数据库配置文件的环境参数取值问题
- 🆕 新增user路由&用户相关的验证规则&用户相关的数据操作

## v0.6.0
`2021/08/07`

- 🆕 用户校验规则新增自定义错误提示
- 🐞 修复防止xss和sql注入无返回值问题
- 🛠 更改错误数据返回方式（具体查看问题讨论1）
- 🆕 新增用户注册功能（作为路由到控制层的demo）
- 🆕 新增业务状态码（具体查看问题讨论2）

